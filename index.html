<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="./js/three.js-master/build/three.js"></script>
    <script src="./js/three.js-master/examples/js/controls/TrackballControls.js"></script>
    <script src="./js/three.js-master/examples/js/controls/OrbitControls.js"></script>
    <script src="./js/three.js-master/examples/js/controls/FirstPersonControls.js"></script>
    <script src="./js/three.js-master/examples/js/loaders/OBJLoader.js"></script>
    <script src="./js/three.js-master/examples/js/loaders/FBXLoader.js"></script>
    <script src="./js/three.js-master/examples/js/loaders/MTLLoader.js"></script>
    <script src="./js/three.js-master/examples/js/loaders/GLTFLoader.js"></script>
    <script src="./js/three.js-master/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="./js/three.js-master/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="./js/three.js-master/examples/js/postprocessing/OutlinePass.js"></script>
    <script src="./js/three.js-master/examples/js/shaders/CopyShader.js"></script>
    <script src="./js/three.js-master/examples/js/libs/dat.gui.min.js"></script>
    <script src="./js/three.js-master/examples/js/libs/stats.min.js"></script>
    <script src="./js/three.js-master/examples/js/libs/inflate.min.js"></script>
    <script src="./js/three.js-master/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="./js/three.js-master/examples/js/postprocessing/RenderPass.js"></script>
    <script src="./js/three.js-master/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="./js/three.js-master/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="./js/three.js-master/examples/js/renderers/CSS2DRenderer.js"></script>
    <script id="vertexShader" type="x-shader/x-vertex">
    varying vec2 vUv;
    void main() {
    vUv = uv;
    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
    }
    </script>
    <script type="x-shader/x-fragment" id="fragmentShader">
    uniform sampler2D baseTexture;
    uniform sampler2D bloomTexture;
    varying vec2 vUv;
    vec4 getTexture( sampler2D texelToLinearTexture ) {
    return mapTexelToLinear( texture2D( texelToLinearTexture , vUv ) );
    }
    void main() {
      gl_FragColor = ( getTexture( baseTexture ) + vec4( 1.0 ) * getTexture( bloomTexture ) );
    }
    </script>


    <title>三维资产查询</title>
    <style>
        #box{
            width:100%;
            height:100%;
        }
        #infolabel{
            content: attr(data-title);
            position: absolute;
            left: -120px;
            top:30px;
            border: 1px solid #5598a1;
            background: #5598a1;
            border-radius: 5px;
            padding: 10px 15px;
        }

    </style>
</head>
<body>
    <script>
        init();
        function init(){
            var selectedObjects = [];
            var clock = new THREE.Clock();
            var scene = new THREE.Scene();
            var composer;
            const box = document.querySelector("#box");
            var stats = new Stats();

            var camera = new THREE.PerspectiveCamera(
                45,window.innerWidth/window.innerHeight,0.1,1000
            );
            var renderer = new THREE.WebGLRenderer({box,
                antialias:true,
                alpha:true
                });
            var renderPass=new THREE.RenderPass(scene,camera);
            var bloomPass = new THREE.UnrealBloomPass( new THREE.Vector2( window.innerWidth, window.innerHeight ), 1.5, 0.4, 0.85 );
            bloomPass.renderToScreen = true;
            bloomPass.threshold = 0;
            bloomPass.strength = 1.5;
            bloomPass.radius = 0;
            composer=new THREE.EffectComposer(renderer);
            composer.setSize( window.innerWidth, window.innerHeight );
            composer.addPass(renderPass);
            composer.addPass( bloomPass );

            
            
            var orbitcontrol = new THREE.OrbitControls(camera, renderer.domElement);
            var raycaster = new THREE.Raycaster();
            var mouse = new THREE.Vector2();

            composer.addPass(renderPass);
            function basistool(){
            var clearColor = new THREE.Color(0xEEEEEE);
            renderer.setClearColor(clearColor);
            renderer.setSize(window.innerWidth,window.innerHeight);
            var plane_bottom =new THREE.PlaneGeometry(60,40);//底面材质
            //材质
            var planeMaterial = new THREE.MeshLambertMaterial(
                {side: THREE.DoubleSide,
                color:0xEEEEEE});
            var plane1 = new THREE.Mesh(plane_bottom,planeMaterial);
            plane1.rotation.x = -.5*Math.PI;
            plane1.position.x=0;
            plane1.position.y=0;
            plane1.position.z=0;
            camera.position.x = 0;
            camera.position.y =100;
            camera.position.z=0;
            camera.lookAt(scene.position);//相机坐标和照相位置
            document.body.appendChild( renderer.domElement );
            }
            basistool();

            //模型加载
            function loder(){
            const gltfLoader = new THREE.GLTFLoader();
            gltfLoader.load(
            "./assert/mesh/机场线/t2/t2_2.gltf",
            function (gltf) {
                console.log(gltf)
                gltf.scene.receiveShadow = true;
                gltf.scene.castShadow = true;
                console.log(gltf);
                gltf.scene.scale.set(1,1,1)
                const levelMesh = gltf.scene.getObjectByName("c");
                const levelMat = new THREE.MeshStandardMaterial({
                // color: Color.GROUND,
                // flatShading: true,
                // roughness: 1,
                // metalness: 0,
                });
                gltf.scene.receiveShadow = true;
                gltf.scene.castShadow = true;
                gltf.scene.traverse(function (node) {
                if (node instanceof THREE.Mesh) {
                    {
                    node.castShadow = true;
                    node.material.emissive = node.material.color;
                    node.material.emissiveMap = node.material.map;
                    }
                }
                });
                scene.add(gltf.scene);
            },
            null
            );
            };
            loder();
            

            function gui(){
            stats.domElement.style.position = 'absolute';
            stats.domElement.style.top = '0px'; //显示在屏幕左上角的地方。
            document.body.appendChild( stats.domElement );//添加到container之后
            }
            gui();

            //灯光效果
            function light(){
            var light = new THREE.DirectionalLight( 0xffffff ); // soft white light
            light.castShadow = true;
            light.shadow.camera.near = 0.1; //产生阴影的最近距离
            light.shadow.camera.far = 10; //产生阴影的最远距离
            light.shadow.camera.left = -2; //产生阴影距离位置的最左边位置
            light.shadow.camera.right = 2; //最右边
            light.shadow.camera.top = 2; //最上边
            light.shadow.camera.bottom = -2; //最下面
            scene.add( light );
            }
            light();

            //天空盒
            function skybox(){
            var path = '/assert/skybox/bak26/';
            var format = '.jpg';
            var urls = [
            path + 'px' + format, path + 'nx' + format,
            path + 'py' + format, path + 'ny' + format,
            path + 'pz' + format, path + 'nz' + format
                        ]
            var materials = [];
            for (var i = 0; i < urls.length; ++i) {
            var loader = new this.THREE.TextureLoader();
            // loader.setCrossOrigin( this.crossOrigin );
            var texture = loader.load(urls[i], function () {}, undefined, function () {})
            materials.push(new this.THREE.MeshBasicMaterial({
                map: texture,
                side: this.THREE.BackSide
                // transparent: true,
                // needsUpdate:true
            })
            )
            };
            var cube = new this.THREE.Mesh(new this.THREE.CubeGeometry(900, 900, 900), materials);
            cube.name = 'sky';
            scene.add(cube);
            var axes = new this.THREE.AxesHelper(100);
            scene.add(axes);
            }
            skybox()

            const info = document.createElement('div');
            
            const infoLabel = new THREE.CSS2DObject(info);
            scene.add(infoLabel);
            var labelRenderer = new THREE.CSS2DRenderer();
            var labelorbitcontrol = new THREE.OrbitControls(camera, labelRenderer.domElement);
            function infobox(x,y,z,name,show){
                infoLabel.position.set(x,y,z);
                document.body.appendChild( labelRenderer.domElement );
                labelRenderer.domElement.style.position = 'absolute';
                labelRenderer.domElement.style.top = show;
                labelRenderer.setSize( window.innerWidth, window.innerHeight );
                info.className = 'label';
                info.id = 'infolabel';
                info.textContent = name;
                info.style.marginTop = '-1em';
            }


            //点击事件
            var borderMesh=[];
            var bordermaterial;
            var bordermaterial1;
            function click(event){
            var raycaster = new THREE.Raycaster();
            var mouse = new THREE.Vector2();
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            //找到场景中所有外部模型
                var scensObjs = [];
                scene.children.forEach(child => {
                for (var i = 0; i < child.children.length; i++) {
                var obj=child.children[i];
                scensObjs.push(obj);
                }
                });
                //返回选中的外部模型对象
                var intersects = raycaster.intersectObjects(scensObjs);
                var objs = [];
                for (var i = 0; i < intersects.length; i++) {
                    var intersect = intersects[i];
                    if (intersect.object instanceof THREE.Mesh) {
                        var obj = intersect.object.parent;
                        //把距离加到模型用户数据里面，方便后面排序
                        obj.userData.distance = intersect.distance;
                        objs.push(obj);
                    }
                }
            objs = objs.sort(function (a, b) {
                return a.userData.distance - b.userData.distance;
            });

            if(intersects.length>0){
                if(borderMesh.length==0){
                    borderMesh = intersects[0].object;
                    a = borderMesh;
                    bordermaterial = borderMesh.material.clone();
                    bordermaterial1 = borderMesh.material.clone();
                    bordermaterial = customMaterial;
                    borderMesh.material=bordermaterial;  
                    console.log(borderMesh);
                    infobox(borderMesh.position.x,borderMesh.position.y+2,borderMesh.position.z,borderMesh.name,'0px')
                    console.log(document.body);
                    console.log()
                }
                else{
                    console.log(borderMesh);
                    borderMesh.material = bordermaterial1;
                    borderMesh = intersects[0].object;
                    a = borderMesh;
                    bordermaterial = borderMesh.material.clone();
                    bordermaterial1 = borderMesh.material.clone();
                    bordermaterial = customMaterial;
                    borderMesh.material=bordermaterial; 
                    infobox(borderMesh.position.x,borderMesh.position.y+2,borderMesh.position.z,borderMesh.name,'0px')
                }
            }
            else{
                borderMesh.material = bordermaterial1;
                var rdiv = document.getElementsByClassName('label')[0];
                infobox(9999,9999,999,'','')
                
            }
        }

        //点击后材质(还需改进)
        var customMaterial = new THREE.ShaderMaterial({
        uniforms: 
        { 
        "s":   { type: "f", value: -1.0},
        "b":   { type: "f", value: 1.0},
        "p":   { type: "f", value: 2.0 },
        glowColor: { type: "c", value: new THREE.Color(0x0033ff) }
        },
        // vertexShader:   document.getElementById( 'vertexShader'   ).textContent,
        // fragmentShader: document.getElementById( 'fragmentShader' ).textContent,
        side: THREE.FrontSide,
        blending: THREE.AdditiveBlending,
        transparent: true
    });

            window.onresize=function(){
            // 重置渲染器输出画布canvas尺寸
                renderer.setSize(window.innerWidth,window.innerHeight);
                composer.setSize(window.innerWidth, window.innerHeight);
                k = window.innerWidth/window.innerHeight;//窗口宽高比
                var s = 100;
                camera.left = -s*k;
                camera.right = s*k;
                camera.top = s;
                camera.bottom = -s;
                camera.updateProjectionMatrix ();
            };

            window.addEventListener( 'click', click, false );//鼠标点击事件
            
            render();
            function render(){
                var delta = clock.getDelta();//使操作更加平滑
                orbitcontrol.update(delta);
                stats.update();
                composer.render();
                window.requestAnimationFrame(render);
                renderer.render(scene,camera);
                labelRenderer.render( scene, camera );
            }
            }
    </script>
    <div id="box"></div>
</body>
</html>